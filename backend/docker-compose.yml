version: "3.9"
services:
  redis:
    image: redis:7
    ports: ["6379:6379"]

  api:
    build: .
    command: sh -c "uvicorn app.main:app --host 0.0.0.0 --port 8000"
    env_file: .env
    environment:
      REDIS_URL: redis://redis:6379/0
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318/v1/traces
      OTEL_SERVICE_NAME: guardrail-api
      GUARDRAIL_API_KEY: ${GUARDRAIL_API_KEY:-demo-key-change-in-production}
    ports: ["8000:8000"]
    depends_on: [redis, jaeger]

  worker:
    build: .
    command: sh -c "rq worker -u ${REDIS_URL:-redis://redis:6379/0} eval --job-timeout 5"
    env_file: .env
    environment:
      REDIS_URL: redis://redis:6379/0
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318/v1/traces
      OTEL_SERVICE_NAME: guardrail-worker
    depends_on: [redis, jaeger]

  prometheus:
    image: prom/prometheus:v2.55.0
    volumes:
      - "./ops/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
      - "./ops/alerts.yml:/etc/prometheus/alerts.yml:ro"
    ports: ["9090:9090"]
    depends_on: [api]

  jaeger:
    image: jaegertracing/all-in-one:1.57
    ports:
      - "16686:16686"   # UI
      - "4317:4317"     # OTLP gRPC
      - "4318:4318"     # OTLP HTTP

